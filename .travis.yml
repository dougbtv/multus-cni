language: go
# see https://docs.travis-ci.com/user/reference/overview/#Virtualization-environments
# for the detail
# sudo: requried
dist: trusty

go:
  - 1.11.x

env:
  global:
    - secure: "oPmhMnnDWp41udz3sqpaCvr/+t6Og8lWKrUJVE3FY4STa6SKsWTXDaE+PwVMknxzjmKmOn5We8ULs95ZAMYisuF+mF6UYqJRgqxxTcAOEMlqD+Myb9y0vozSPB/cbxh1ABz5fRD2IP7m04lZpwY41+p6kbpYID1Ywax2VoveA73jzspn1gVCf7o2RBlEaAVXOERleyWWNo7+Ce1MKTNv/ziE2BhuCDdGzh8BvK1Av6U3j3M/KfdwtqyNhFOZho9uHAi3k8a2DPD1nUQito7YURa8+CgAlQ9t6EJve4cxubvQP3EPavslN/vgfTtU62NO5i0f7Mfn35LQBGglxmD3nX0+FdCvzU3gRtsLwRVCM1cWBRY7juCsULMbl+PufjTratCgEhbX9Xwo8uWQlgq9/JaUbK1O8vQ0OEpkJTMD/Cpz4Nc2CDlcoAk3wU2RkTEHo1oR94i6+N0PLNW/CsrbpG5LhaxcT53OERtcyDbh7ZQ0Ldq6LwR67Dfl2sE9ovgFAWPRPMZSQYq5lsudZdQoSP46kMR9UlXdY8Jnzk2ufZZtCHpD/f+AHOj441tz5PaA0emtEFXwFclspTKi+wXHyWmPykSfLEtmoj27uT4AuEMpiuz4oHpCwBtKMicDzCA/MowxpoG/Cnjgqslf0X3xNBm0VRFtIZQaPEPEjpojKFc="    - MULTUS_GOPATH=${PWD}/gopath

before_install:
  - sudo apt-get update -qq
  - go get github.com/mattn/goveralls

install:
  - go get -u golang.org/x/lint/golint

before_script:
  # Make gopath... to run golint/go fmt/go vet
  - |-
    if [ ! -h gopath/src/github.com/intel/multus-cni ]; then
        mkdir -p gopath/src/github.com/intel
        ln -s ../../../.. gopath/src/github.com/intel/multus-cni || exit 255
    fi
  - env GOPATH=${MULTUS_GOPATH} golint gopath/src/github.com/intel/multus-cni/multus/... | grep -v ALL_CAPS | xargs -r false
  - env GOPATH=${MULTUS_GOPATH} go fmt gopath/src/github.com/intel/multus-cni/...
  - go tool vet */*.go
#  - gocyclo -over 15 ./multus

script:
  - ./build
  - sudo ./test.sh
  - |-
    GOV_GOPATH=${PWD}/gopath
    pushd gopath/src/github.com/intel/multus-cni
    env GOPATH=${GOV_GOPATH} ${GOPATH}/bin/goveralls -coverprofile=coverage.out -service=travis-ci
    popd
  - mkdir -p ${TRAVIS_BUILD_DIR}/dist
  - tar cvfz ${TRAVIS_BUILD_DIR}/dist/multus-cni_amd64.tar.gz --warning=no-file-changed --exclude="dist" --exclude="vendor" .
  - docker build -t dougbtv/multus-defaultnet .

deploy:
  # Push images to Dockerhub on merge to master
  - provider: script
    on:
      branch: default-per-namespace
    script: >
      bash -c '
      docker tag dougbtv/multus-defaultnet dougbtv/multus-defaultnet:snapshot;
      docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS";
      docker push dougbtv/multus-defaultnet:snapshot; 
      echo foo'